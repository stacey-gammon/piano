<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chord Degree Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        button {
            margin: 5px;
            padding: 10px 15px;
            font-size: 16px;
            cursor: pointer;
        }
        .chord-info {
            background: #f0f0f0;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }
        .console {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 3px;
            font-family: monospace;
            height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>Chord Degree System Test</h1>
    
    <div class="test-section">
        <h2>Testing B Minor Key</h2>
        <p>In B minor, the scale degrees map to these notes:</p>
        <ul>
            <li><strong>1</strong> = B (root)</li>
            <li><strong>2</strong> = C# (second)</li>
            <li><strong>3</strong> = D (third) - <em>minor third!</em></li>
            <li><strong>4</strong> = E (fourth)</li>
            <li><strong>5</strong> = F# (fifth)</li>
            <li><strong>6</strong> = G (sixth)</li>
            <li><strong>7</strong> = A (seventh)</li>
        </ul>
        
        <p>So when you play chord degree <strong>1</strong>, it should build a B minor chord using degrees 1, 3, 5:</p>
        <ul>
            <li>Degree 1 â†’ B</li>
            <li>Degree 3 â†’ D</li>
            <li>Degree 5 â†’ F#</li>
            <li><strong>Result:</strong> B minor chord (B, D, F#)</li>
        </ul>
    </div>
    
    <div class="test-section">
        <h2>Test Chord Degrees</h2>
        <p>Click the buttons below to test different chord degrees in B minor:</p>
        <button onclick="testChordDegree('1', 'Bm')">Play Degree 1 (should be Bm)</button>
        <button onclick="testChordDegree('2', 'Bm')">Play Degree 2 (should be C#dim)</button>
        <button onclick="testChordDegree('3', 'Bm')">Play Degree 3 (should be D)</button>
        <button onclick="testChordDegree('4', 'Bm')">Play Degree 4 (should be Em)</button>
        <button onclick="testChordDegree('5', 'Bm')">Play Degree 5 (should be F#)</button>
        <button onclick="testChordDegree('6', 'Bm')">Play Degree 6 (should be G)</button>
        <button onclick="testChordDegree('7', 'Bm')">Play Degree 7 (should be A)</button>
    </div>
    
    <div class="test-section">
        <h2>Console Output</h2>
        <div id="console" class="console"></div>
    </div>
    
    <div class="test-section">
        <h2>How It Works</h2>
        <p>The new system:</p>
        <ol>
            <li>Recognizes when you pass a scale degree (1-7) instead of a chord name</li>
            <li>Maps that degree to the appropriate chord pattern (e.g., degree 1 â†’ [1,3,5])</li>
            <li>Converts each degree to an actual note using the key's scale</li>
            <li>Builds the chord dynamically from those notes</li>
        </ol>
        
        <p>This means:</p>
        <ul>
            <li>No more hardcoded chord definitions needed</li>
            <li>Works with any key (major or minor)</li>
            <li>Follows proper music theory</li>
            <li>Much more flexible and maintainable</li>
        </ul>
    </div>

    <script>
        // Mock the audio context and other dependencies for testing
        const audioContext = {
            createOscillator: () => ({
                connect: () => {},
                frequency: { setValueAtTime: () => {} },
                type: 'triangle',
                start: () => {},
                stop: () => {}
            }),
            createGain: () => ({
                connect: () => {},
                gain: { setValueAtTime: () => {}, linearRampToValueAtTime: () => {} }
            }),
            destination: {},
            currentTime: 0
        };
        
        const eighthNoteLength = 500; // 500ms for testing
        
        // Mock the note frequencies
        const noteFreqs = {
            'B4': 493.88, 'C#5': 554.37, 'D5': 587.33, 'E5': 659.25, 
            'F#5': 739.99, 'G5': 783.99, 'A5': 880.00
        };
        
        // Mock the mapDegreeToNote function
        function mapDegreeToNote(scaleDegree, octave, songKey) {
            const majorScale = [0, 2, 4, 5, 7, 9, 11];
            const minorScale = [0, 2, 3, 5, 7, 8, 10];
            
            const rootNote = songKey.replace("m", "") + octave;
            const rootFreq = noteFreqs[rootNote];
            
            if (!rootFreq) return null;
            
            const semitones = songKey.includes("m") ? minorScale[scaleDegree - 1] : majorScale[scaleDegree - 1];
            const frequency = rootFreq * Math.pow(2, semitones / 12);
            
            // Find closest note
            let closestNote = null;
            let smallestDiff = Infinity;
            
            for (const [note, freq] of Object.entries(noteFreqs)) {
                const diff = Math.abs(freq - frequency);
                if (diff < smallestDiff) {
                    smallestDiff = diff;
                    closestNote = note;
                }
            }
            
            return closestNote;
        }
        
        // Mock the playNote function
        function playNote(note, trackVolume, duration) {
            logToConsole(`Playing note: ${note} for ${duration}s`);
        }
        
        // The actual functions from your audioPlayer.js
        function buildChordFromDegrees(scaleDegrees, songKey, octave = 4) {
            if (!songKey || !Array.isArray(scaleDegrees)) {
                return null;
            }
            
            logToConsole(`Building chord from degrees ${scaleDegrees} in key ${songKey}`);
            
            const chordNotes = [];
            for (const degree of scaleDegrees) {
                const note = mapDegreeToNote(degree, octave, songKey);
                if (note) {
                    chordNotes.push(note);
                    logToConsole(`Degree ${degree} â†’ Note ${note}`);
                }
            }
            
            logToConsole(`Final chord notes: ${chordNotes}`);
            return chordNotes.length > 0 ? chordNotes : null;
        }
        
        function getChordDegrees(position) {
            const chordPatterns = {
                1: [1, 3, 5],    // Root chord (1-3-5)
                2: [2, 4, 6],    // Second chord (2-4-6)
                3: [3, 5, 7],    // Third chord (3-5-7)
                4: [4, 6, 1],    // Fourth chord (4-6-1)
                5: [5, 7, 2],    // Fifth chord (5-7-2)
                6: [6, 1, 3],    // Sixth chord (6-1-3)
                7: [7, 2, 4]     // Seventh chord (7-2-4)
            };
            
            return chordPatterns[position] || null;
        }
        
        function playChord(chordName, trackVolume = null, duration = 1, songKey = null) {
            let chordNotes = null;
            
            // Check if this is a scale degree (1, 2, 3, 4, 5, 6, 7)
            if (/^[1-7]$/.test(chordName)) {
                const degree = parseInt(chordName);
                logToConsole(`Playing chord degree ${degree} in key ${songKey}`);
                const chordDegrees = getChordDegrees(degree);
                
                if (chordDegrees && songKey) {
                    chordNotes = buildChordFromDegrees(chordDegrees, songKey);
                }
            }
            
            if (!chordNotes) {
                logToConsole(`Could not build chord for: ${chordName}`);
                return;
            }
            
            // Play all notes in the chord
            chordNotes.forEach(note => {
                playNote(note, trackVolume, duration);
            });
            
            logToConsole(`âœ… Played chord: ${chordNotes.join(', ')}`);
        }
        
        function testChordDegree(degree, key) {
            logToConsole(`\nðŸŽµ Testing chord degree ${degree} in key ${key}`);
            playChord(degree, null, 1, key);
        }
        
        function logToConsole(message) {
            const console = document.getElementById('console');
            console.innerHTML += message + '\n';
            console.scrollTop = console.scrollHeight;
        }
        
        // Initialize console
        logToConsole('ðŸŽ¹ Chord Degree System Test Ready!');
        logToConsole('Click the buttons above to test different chord degrees in B minor.');
    </script>
</body>
</html>
